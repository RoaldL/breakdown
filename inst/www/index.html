<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>Breakdown analysis</title>
	<link rel="stylesheet" type="text/css" href="js/themes/default/easyui.css">
	<link rel="stylesheet" type="text/css" href="js/themes/icon.css">
	<link rel="stylesheet" type="text/css" href="js/jquery.slider.min.css">
	<script type="text/javascript" src="js/jquery.min.js"></script>
	<script type="text/javascript" src="js/jquery.easyui.min.js"></script>
	<script type="text/javascript" src="js/jquery.slider.min.js"></script>
	<!-- note all sliders are http://egorkhmelev.github.io/jslider/ not jeasyui -->
	<script type="text/javascript" src="js/underscore.1.6.0.min.js"></script>
	<script type="text/javascript" src="js/backbone.1.1.2.min.js"></script>
	<script type="text/javascript" src="js/jquery.csv-0.71.min.js"></script>
	<script type="text/javascript" src="js/opencpu-0.5.js"></script>
	
	<link href="//cdnjs.cloudflare.com/ajax/libs/x-editable/1.5.0/jquery-editable/css/jquery-editable.css" rel="stylesheet"/>
	<script src="//cdnjs.cloudflare.com/ajax/libs/x-editable/1.5.0/jquery-editable/js/jquery-editable-poshytip.min.js"></script>
	<style>
	.highconcern {color:red}
	.midconcern {color:orange}
	.lowconcern {color:green}
	#univariate>table>tbody>tr{
		border-bottom-style: solid;
		border-bottom-width: 1px;
		border-bottom-color: grey;
		text-align:right;
	}
	.jslider{display:inline-block;width:150px;margin-bottom:20px;margin-top:15px;margin-left:7px;margin-right:7px}

	.definition {
		border-bottom: 1px dotted #000;
		text-decoration: none;
	}
	</style>

</head>
<body class="easyui-layout">

	<script type="text/template" id="outputstats_template">
		<%-variable%> of <%- baseline %>: $<% print((baseline_value).toFixed(2)) %><br/>
		<%-variable%> of <%- scen %>: $<% print((scen_value).toFixed(2)) %><br/>
		difference: $<% print((scen_value-baseline_value).toFixed(2)) %>	
	</script>
	
	<script type="text/template" id="univTable_template">
		<form><table>
			<thead>
			<th>Variable</th>
			<th></th>
			<th title="% distance from best guess">Level of comfort</th>
			<th title="% distance from bound">Level of concern</th>
			<th>Value at crossover point</th>
			<th>% change of best guess</th>
			<th>NPV</th>
			</thead>
			<tbody>
			 <% _.each( tab, function( row ){ %>
				<tr align="middle" <% if(row.concernClass){ print("class="+row.concernClass)} %>>
					<td align="right"><%- row.Variable%></td>
					<td><input id="<%-id%>_<%-row.Variable%>" value="<%-row.Lower%>;<%-row.Upper%>" type="slider"/></td>
					<td><% if(row.PercToLimit && !isNaN(parseFloat(row.PercToLimit))){ print((row.PercToLimit*100).toFixed(1)+"%")} %></td>
					<td><% if(row.PercToLimit && !isNaN(parseFloat(row.PercToLimit))){ print(((1-row.PercToLimit)*100).toFixed(1)+"%")} %></td>
					<td><% if(row.Break && !isNaN(parseFloat(row.Break))){print(row.Break.toFixed(4))} %></td>
					<td><% if(row.PercChange && !isNaN(parseFloat(row.PercChange))){print(row.PercChange.toFixed(2)+"%")} %></td>
					<td><% if(row.NPV){print(row.NPV)} %></td>
					<td><input type="radio" name="selectedVar" value="<%- row.Variable %>"></td>
				</tr>
			  <% }); %>
			</tbody>
		</table></form>
	</script>
	
	<script type="text/template" id="BivariateRadioButtonTable_template">
		<table>
			<thead>
				<th>Variable</th>
				<th></th>
				<th>Var 1</th>
				<th>Var 2</th>
			</thead>
			<tbody>
				<% _.each( ranges, function( row ){ %>
				<tr valign='middle'>
					<td style='text-align:right'><%print(row[0])%></td>
					<td><input id="<%-id%>_<%print(row[0])%>" value="<%print(row[1])%>;<%print(row[5])%>" type="slider"/></td>
					<td style='text-align:center'><input type = "radio" name="<%-inputId%>" value=<%print(row[0])%>></td>
					<td style='text-align:center'><input type = "radio" name="<%-inputId2%>" value=<%print(row[0])%>></td>
				</tr>
				<% }); %>
			</tbody>
		</table>
	</script>
	
	<script type="text/template" id="MultiVarRB_template">
		<table>
			<thead>
				<th>Variable</th>
				<th></th>
				<th>Vary?</th>
			</thead>
			<tbody>
				<% _.each( ranges, function( row ){ %>
				<tr valign='middle'>
					<td style='text-align:right'><%print(row[0])%></td>
					<td><input id="<%-id%>_<%print(row[0])%>" value="<%print(row[1])%>;<%print(row[5])%>" type="slider"/></td>
					<td style='text-align:center'><input type = "checkbox" name="<%-inputId%>" value=<%print(row[0])%>></td>
				</tr>
				<% }); %>
			</tbody>
		</table>
	</script>
	
	<script type="text/template" id="MultiVarResultsTable_template">
		<table>
			<thead>
				<th>Variable</th>
				<th>Min</th>
				<th>Max</th>
				<th>Single variable<br/>breakpoint</th>
				<th>Best guess</th>
				<th>Many variable<br/>breakpoint</th>
				<th>Change</th>
				<th title="% distance from bound">Level of concern</th>
			</thead>
			<tbody>
				<% _.each( results, function( row ){ %>
				<tr>
					<td><%-row.Variable%></td>
					<!-- TODO: neater robust number formatting -->
					<td align='right'><% if(!isNaN(parseFloat(row.Min))){ print(parseFloat(row.Min).toFixed(2))}%></td>
					<td align='right'><% if(!isNaN(parseFloat(row.Max))){ print(parseFloat(row.Max).toFixed(2))}%></td>
					<td align='right'><% if(!isNaN(parseFloat(row.univar))){ print(parseFloat(row.univar).toFixed(2))}%></td>
					<td align='right'><% if(!isNaN(parseFloat(row.Best))){ print(parseFloat(row.Best).toFixed(2))}%></td>
					<td align='right'><% if(!isNaN(parseFloat(row.multvar))){ print(parseFloat(row.multvar).toFixed(2))}%></td>
					<td align='right'><% if(!isNaN(parseFloat(row.change))){ print(parseFloat(row.change).toFixed(2))}%></td>
					<td align='right'><% if(!isNaN(parseFloat(loc))){ print(parseFloat(loc).toFixed(2))}%></td>
				</tr>
				<% }); %>
			</tbody>
		</table>
	</script>

	<script type="text/template" id="EditBounds_template">
		<ul>
		<li>The best guess value for <%-variable%> is <span data-name='Best' class='xeditable' data-type='text' data-title='Enter best guess value'><%-Best%></span>.</li>
		<li>The minimum value for which a crossover point could be of concern is <span data-name='Min' class=xeditable data-type='text' data-title='Enter minimum value of concern'><%-Min%></span>.</li>
		<li>The maximum value for which a crossover point could be of concern is <span data-name='Max' class=xeditable data-type='text' data-title='Enter maximum value of concern'><%-Max%></span>.</li>
		If a cross-over point is outside these bounds, it is not of concern.
		</ul>
	</script>
	
	<div data-options="region:'north'" style="height:70px;padding:5px">
			<h1>Breakdown analysis</h1>
	</div>
		
	<div id="tabs" data-options="region:'center',plain:true,tabPosition:'left',headerWidth:170,onSelect:tabs_handle_render" class="easyui-tabs">	
		<style>
			.l-btn{
				vertical-align:middle;
			}
			.button-sep{
				display:inline-block;
				width:0;
				height:22px;
				border-left:1px solid #ccc;
				border-right:1px solid #fff;
				vertical-align:middle;
			}
		</style>
		<div title="Load" style="padding:20px">
			
			<div class="easyui-panel" style="padding:5px;">
				<a href="#" class="easyui-linkbutton" onclick='loadDemo(analysis)' data-options='plain:true,iconCls:"icon-tip"'>Load demo</a>
				<span class="button-sep"></span>
				<a href="#" class="easyui-linkbutton" onclick='$("#csvAllInput").click()' data-options='plain:true,iconCls:"icon-add"'>Load combined CSV</a>
				<input type="file" id="csvAllInput" onchange="readCsv(this.files,function(x){analysis.AllFromCSV(x)},';')" accept=".csv" style="display:none">
				<span class="button-sep"></span>
				<a href="#" class="easyui-linkbutton" onclick='$("#csvEquationsInput").click()' data-options='plain:true,iconCls:"icon-add"'>Load equations CSV</a>
				<input type="file" id="csvEquationsInput" onchange="readCsv(this.files,function(x){analysis.EquationsfromCSV(x)})" accept=".csv" style="display:none">
				<span class="button-sep"></span>
				<a href="#" class="easyui-linkbutton" onclick='setDefault(analysis)' data-options='plain:true,iconCls:"icon-sum"'>Set default ranges</a>
				<span class="button-sep"></span>
				<a id="dl_csv" class="easyui-linkbutton" download='breakdown.csv' onclick='downloadCSV(analysis)' data-options='plain:true,iconCls:"icon-save"'>Download combined CSV</a>
				<span class="button-sep"></span>
			</div>
			<h2>Load equations and ranges</h2>
			<li>'Load equations CSV' expects a CSV with first column the name of each variable, and other columns the equation to calculate each variable</li>
			<li>'Set default ranges' calculates default analysis bounds as 1% and 1000% of the modeled numeric values defined in the equations</li>
			<h2>Save equations and ranges</h2>
			<li>'Download combined csv' exports a csv that includes ranges, notes and equations for all variables</li>
			<h2>Define settings</h2>
			<style>
			.unknown-scen{color:red}
			</style>
			<label for='select_base'>Baseline: </label><input id="select_base" name="select_base" value="">			
			<label for='select_scen'>Scenario: </label><input id="select_scen" name="select_scen" value="">
			<a class="easyui-linkbutton" onclick='addScens(analysis,[$("#select_base").combobox("getText"),$("#select_scen").combobox("getText")])'>Add new scenarios</a>
		</div>
	
		<div title="Equations" data-options="fit:true"><div class="easyui-layout" data-options="fit:true">
			
			<div data-options="region:'center'">
				<div id="eq_tb">
					<a href="#" class="easyui-linkbutton" iconCls="icon-add" plain="true" onclick='addrow($("#dg-equations"))'>Add</a>
					<a href="#" class="easyui-linkbutton" iconCls="icon-remove" plain="true" onclick='deleterow($("#dg-equations"),analysis,"equations")'>Delete</a>
				</div>
				<table id="dg-equations" toolbar="#eq_tb"></table>		
			</div>
			
			<div id="explain" style="padding:10px;width:200px;" data-options="region:'east',split:true,collapsible:true"></div>

		</div></div>	
		
		<div title="Equation Breakdown"><div class="easyui-layout" data-options="fit:true">
			<div data-options="region:'north'" style="height:35px;padding:5px;border:false;collapsible:false">
				<a href="#" class="easyui-linkbutton" onclick='analysis.set("showEquation",!analysis.get("showEquation"))'>Toggle equations</a>
			</div>
			<div data-options="region:'center'" class="easyui-panel" style="padding:5px">
				<table id="tt"></table>
			</div>
		</div></div>	
		
		<div title="Variable Ranges">
			<div id="ra_tb">
				<a href="#" class="easyui-linkbutton" iconCls="icon-add" plain="true" onclick='addrow($("#dg-ranges"))'>Add</a>
				<a href="#" class="easyui-linkbutton" iconCls="icon-remove" plain="true" onclick='deleterow($("#dg-ranges"),analysis,"ranges")'>Delete</a>
			</div>
			<table id="dg-ranges" toolbar="#ra_tb"></table>
		</div>

		<div title="Single variable breakpoints" id="tab_univ"><div class="easyui-layout" data-options="fit:true">		
			<div data-options="region:'center'" style="padding:10px;">
				<div>
					<h2>How much does a single variable need to change to reach a crossover point?</h2>
					For each variable separately, we aim to identify the value of that variable at which two alternatives have the same output, i.e. where a cross-over point occurs.
					The cross-over points are ranked by their <span title="% distance from bound" class=definition>level of concern</span>/<span title="% distance from best guess" class=definition>level of comfort</span>. 
					(<a href="#" onclick="$('#explain_loc').window('open');">Show more</a>)<br/>
				</div>
				<p><em>Levels of comfort and concern depend on the best guess, minimum and maximum values.
				They are justified and can be edited in the pane on the right for the variable selected in the table.</em></p>
				<div id="univariate"></div>
			</div>
			<div data-options="region:'east',split:true,collapsible:true" style="width:500px;padding:10px">
				<div id="singleplot" class="easyui-resizable" data-options="maxWidth:2048,maxHeight:1536" style="border: 1px solid rgb(204, 204, 204);width:400px;height:250px"></div>
				<!--
				<p><em>Levels of comfort and concern depend on the best guess, minimum and maximum values. 
					They are justified here and can be edited for the variable selected in the table on the left.</em></p>
				<br/>-->
				<br/>
				<div id="editbound1"></div>
				<br/>
				<b>Why is the best guess value selected:</b>
				<br/>
				<p id="notes_bestguess1" style="width:100%"></p>
				  <br>
                  <b>What influences the bounds:</b>
                  <br/>
                  <li>Is this crossover point of concern? Why/why not?</li>
                  <li>What should the bounds be?</li>
                  <li>If there is no crossover point, is this expected? why?</li>
				  <p id="notes_bounds1" style="width:100%"></p>
                  <br/>
                  <b>What direction of change is expected? Does it match the model results?</b>
				  <p id="notes_direction1" style="width:100%"></p>
                  <br/>
                  <b>Given this crossover point exists, can we conclude that any of the options should be ruled out? Why?</b>
                  <li>What further analysis might show the crossover point is not of concern?</li>
                  <li>What can we do to avoid this crossover point?</li>
                  <p id="notes_is_problem1" style="width:100%"></p>
			</div>
		</div></div>
		
		<style>
		#bi_n + .slider {display:inline-block;margin-left:10px;margin-right:10px}
		</style>
		<div title="Two variable breakpoints" style="padding:10px"><div class='easyui-layout' data-options="fit:true">
			<div data-options="region:'center'" style="padding:10px;" id="biv_table"></div>
			<div data-options="region:'east',split:true,collapsible:true" style="width:500px;padding:10px">
				<div id="biplot" class="easyui-resizable" data-options="maxWidth:2048,maxHeight:1536" style="border: 1px solid rgb(204, 204, 204);width:400px;height:250px"></div>
				<div style="padding:2px;margin-bottom:30px;margin-top:20px">
					<label for=bi_n>Number of points</label>
					<input id="bi_n" type="slider" value="10" style="width:300px">
				</div>
				<label for=biv_flip>Flip axes</label><input type='checkbox' id='biv_flip'>
			</div>
		</div></div>
		
		<div title="Many-variable breakpoints"><div class='easyui-layout' data-options="fit:true">
			<div data-options="region:'center'" style="padding:10px;" id="mult_table"></div>
			<div data-options="region:'east',split:true,collapsible:true" style="width:500px;padding:10px">
				<a href="#" class="easyui-linkbutton" onclick='mult.crossoverEquiconcern()'>Update many-variable breakpoints</a><br/>
				<div id='mult_output'></div>
			</div>
		</div></div>
	</div>
	
    <div id="win" class="easyui-window" title="Edit range" style="width:400px;height:200px"
    data-options="iconCls:'icon-save',modal:true,closed:true">
    </div>	

    <div id="explain_loc" class="easyui-window" title="Level of concern" style="width:400px;height:200px" data-options="iconCls:'icon-info',modal:false,closed:true">
		<ul id="">
			<li>If a cross-over point is close to the best guess, it is of greater concern and lower comfort, because we may have a high risk of reaching that cross-over point. </li>
			<li>If it is close to the specified maximum or minimum value, it is of lower concern and higher comfort because we have a high margin of safety.</li>
			<li>If the level of comfort is less than 0% (or level of concern is greater than 100%), then the crossover point falls outside the specified bounds, meaning that it is not considered to be of concern.</li>
		</ul>
	</div>	
	
	<script type="text/javascript" src="model.js"></script>
	<script type="text/javascript" src="view_datagrids.js"></script>
	<script type="text/javascript" src="univariate.js"></script>
	<script type="text/javascript" src="bivariate.js"></script>
	<script type="text/javascript" src="multivariate.js"></script>
	<script type="text/javascript" src="treemodel.js"></script>
	<script type="text/javascript">
		var analysis = new Analysis();
		var dgEquations = new DGEquations({ model: analysis, el: $("#dg-equations") });
		var dgRanges = new DGRanges({ model: analysis, el: $("#dg-ranges") });
		var npvText = new OutputStats({ model: analysis, el: $("#explain"), variable:'NPV' });

		var singleOutputPlot = new SingleOutputPlot({model:analysis, el:$("#singleplot")});
		
		var univ = new UnivariateAnalysis({base:analysis});
		var univTable = new UnivariateTable2({model:univ,el:$("#univariate")});
		var editbound1 = new EditBounds({model:analysis,el:$("#editbound1")})
		
		var biv=new BivariateAnalysis({base:analysis});
		var bivOutputPlot = new BivOutputPlot({model:biv, el:$("#biplot")});
		var biRadio = new BivRadioButtonTable({model:biv,el:$("#biv_table")});
		$("#biv_flip").on('change',function(){biv.set("flip",$(this).is(':checked'))});
		$("#bi_n").slider({from:0,to:400,scale:[0,'|',100,'|',200,'|',300,'|',400],limits:false,
					callback:function(v){biv.set('n',parseInt(v))}
					});
					
		var mult= new MultivarCrossover({base:analysis});
		var multCheck = new MultivarCheckboxTable({model:mult,el:$("#mult_table"),template:$("#MultiVarRB_template")});
		ocpu.seturl("/breakdown/R")
		//ocpu.seturl("http://josephguillaume.ocpu.io/breakdown/R")
		var multOut= new MultivarResultsTable({model:mult,univariate:univ,el:$("#mult_output"),template:$("#MultiVarResultsTable_template")});
		
		var treeView = new TreeView({
							model: analysis,
							el: $("#tt") 
							});
		var selectBase = new SelectScens({model:analysis,el:$('#select_base'),wscen:0});
		var selectScen = new SelectScens({model:analysis,el:$('#select_scen'),wscen:1});
		
		var notes1=_.map(["bestguess","bounds","direction","is_problem"],function(n){ return new EditableNote({model:analysis,el:$("#notes_"+n+"1"),field:n})});
		
		tabs_handle_render = function(title,idx){
			//console.log(title+' '+idx)
			if(idx==4) singleOutputPlot.render();
			if(idx==5) bivOutputPlot.render();
		}
		
		}
	</script>
	
	
</body>
</html>